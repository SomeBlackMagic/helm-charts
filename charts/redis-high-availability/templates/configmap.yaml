apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "haproxy.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "haproxy.labels" . | nindent 4 }}
data:
  haproxy.cfg: |+
    global
        daemon
        maxconn {{ .Values.configmap.global.maxconn }}
        log stdout local0 debug

    defaults
        log global
        mode tcp
        timeout connect {{ .Values.configmap.defaults.timeoutConnect }}
        timeout client {{ .Values.configmap.defaults.timeoutClient }}
        timeout server {{ .Values.configmap.defaults.timeoutServer }}

    {{- if .Values.configmap.frontendHttpEnabled }}
    frontend http
        bind :8080
        default_backend stats
    {{- end }}

    {{- with .Values.configmap.backendStats }}
    backend stats
        mode http
        stats enable
        stats uri {{ .uri }}
        stats refresh {{ .refresh }}
        stats show-legends
        stats admin if {{ .admin }}
    {{- end }}

    resolvers k8s
      parse-resolv-conf
      hold other {{ .Values.configmap.resolvers.holdOther }}
      hold refused {{ .Values.configmap.resolvers.holdRefused }}
      hold nx {{ .Values.configmap.resolvers.holdNx }}
      hold timeout {{ .Values.configmap.resolvers.holdTimeout }}
      hold valid {{ .Values.configmap.resolvers.holdValid }}
      hold obsolete {{ .Values.configmap.resolvers.holdObsolete }}

    frontend redis-read
        bind *:{{ .Values.configmap.frontend.redisReadPort }}
        default_backend redis-online

    frontend redis-write
        bind *:{{ .Values.configmap.frontend.redisWritePort }}
        default_backend redis-primary

        backend redis-primary
        mode tcp
        balance {{ .Values.configmap.backend.balanceAlgorithm }}
        option tcp-smart-connect
        option tcpka
        option tcp-check
        {{- if $.Values.redis.auth.enabled }}
        tcp-check send AUTH\ {{ $.Values.redis.auth.password }}\r\n
        {{- end }}
        tcp-check expect string +OK
        tcp-check send info\ replication\r\n
        tcp-check expect string role:master

        {{- range $i := until (int $.Values.redis.replica.replicaCount) }}
        server redis-node-{{ $i }} {{ $.Release.Name }}-node-{{ $i }}.{{ $.Release.Name }}-headless.{{ $.Release.Namespace }}.svc.{{ $.Values.clusterDomain }}:6379 check inter 1s rise 30 fall 2
        {{- end }}


    backend redis-online
        mode tcp
        balance {{ .Values.configmap.backend.balanceAlgorithm }}

        {{- range $i := until (int $.Values.redis.replica.replicaCount) }}
        server redis-node-{{ $i }} {{ $.Release.Name }}-node-{{ $i }}.{{ $.Release.Name }}-headless.{{ $.Release.Namespace }}.svc.{{ $.Values.clusterDomain }}:6379 check inter 1s rise 30 fall 2
        {{- end }}
